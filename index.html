<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kliensoldali Vide√≥ Ford√≠t√≥ (v2.17 - Szuper-Stabil)</title>
    <style>
        /* A st√≠lus nem v√°ltozott */
        body { font-family: sans-serif; max-width: 800px; margin: 20px auto; padding: 10px; background-color: #f4f4f4; } h1 { text-align: center; } #container { background-color: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); } input[type="file"] { display: block; margin: 20px 0; } button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-right: 10px; } button:disabled { background-color: #ccc; } #status { font-family: monospace; font-weight: bold; background-color: #e0e0e0; padding: 10px; border-radius: 5px; } #log-container { margin-top: 20px; } #log { font-family: monospace; white-space: pre-wrap; word-wrap: break-word; background-color: #222; color: #00ff00; padding: 15px; border-radius: 5px; margin-top: 10px; height: 300px; overflow-y: scroll; font-size: 12px; } textarea { width: 95%; height: 150px; margin-top: 10px; }
    </style>
</head>
<body>
    <div id="container">
        <h1>ü§ñ B√∂ng√©sz≈ëben fut√≥ Felirat K√©sz√≠t≈ë (v2.17)</h1>
        <p>V√°lassz ki egy angol nyelv≈± vide√≥- vagy hangf√°jlt. (Ez a verzi√≥ mindent dinamikusan t√∂lt be, √©s fut√°sid≈ëben ellen≈ërzi a headereket.)</p>
        
        <input type="file" id="file_input" accept="audio/*, video/*">
        <button id="process_button">Feldolgoz√°s Ind√≠t√°sa</button>

        <h3 id="status_header" style="margin-top: 20px;">√Ållapot:</h3>
        <div id="status">V√°rakoz√°s a f√°jlra...</div>
        
        <div id="log-container">
            <h3>Log kimenet:</h3>
            <div id="log">Ind√≠t√°sra v√°rva...</div>
        </div>
        
        <div id="results_container" style="display:none;">
            </div>
    </div>

    <script type="module">
        // --- FIGYELEM: Nincs 'import pipeline' itt! ---
        // Mindent a gombnyom√°s ut√°n t√∂lt√ºnk be.

        // Glob√°lis v√°ltoz√≥k a bet√∂lt√∂tt funkci√≥knak
        let pipeline = null;
        let ffmpeg = null;
        
        // V√°ltoz√≥k (DOM elemek)
        const fileInput = document.getElementById('file_input');
        const processButton = document.getElementById('process_button');
        const statusDiv = document.getElementById('status');
        const logDiv = document.getElementById('log');
        const resultsContainer = document.getElementById('results_container');
        const resultsSrt = document.getElementById('results_srt');
        const downloadSrtBtn = document.getElementById('download_srt_btn');
        const downloadVideoBtn = document.getElementById('download_video_btn');
        let srtContent = "";
        let inputFile = null;
        
        // Helper funkci√≥k (V√ÅLTOZATLAN)
        function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }
        function logMessage(message) { console.log(message); logDiv.innerHTML += `[${new Date().toLocaleTimeString()}] ${message}\n`; logDiv.scrollTop = logDiv.scrollHeight; }
        function updateStatus(message, percentage = null) { if (percentage !== null) { statusDiv.textContent = `${message} - ${percentage.toFixed(2)}%`; } else { statusDiv.textContent = message; } }
        const progressCallback = (data) => { if (data.status === 'download') { updateStatus(`Modell let√∂lt√©se: ${data.name}`, data.progress); logMessage(`Let√∂lt√©s: ${data.file} (${(data.loaded / 1024 / 1024).toFixed(2)}MB / ${(data.total / 1024 / 1024).toFixed(2)}MB)`); } else if (data.status === 'progress') { updateStatus('Feldolgoz√°s...', data.progress); } else if (data.status === 'done') { updateStatus('Bet√∂ltve. Feldolgoz√°s indul.'); } else { logMessage(`St√°tusz: ${data.status}`); } };

        // --- Dinamikus Szkriptbet√∂lt≈ë (V√ÅLTOZATLAN) ---
        function loadScript(url) {
            return new Promise((resolve, reject) => {
                logMessage(`Lok√°lis szkript bet√∂lt√©se: ${url}`);
                const script = document.createElement('script');
                script.src = url;
                script.onload = () => {
                    logMessage(`Szkript bet√∂ltve: ${url}`);
                    resolve();
                };
                script.onerror = () => {
                    logMessage(`FAT√ÅLIS HIBA a lok√°lis szkript bet√∂lt√©sekor: ${url}.`);
                    reject(new Error(`Sikertelen szkriptbet√∂lt√©s: ${url}`));
                };
                document.head.appendChild(script);
            });
        }

        // --- FFmpeg Bet√∂lt≈ë (STABIL, EGY-SZ√ÅL√ö) ---
        async function loadFFmpeg() {
            if (ffmpeg) return ffmpeg;
            
            logMessage("FFmpeg (Single-Thread) bet√∂lt√©se...");
            updateStatus("FFmpeg bet√∂lt√©se...");

            // --- √öJ V√âGS≈ê ELLEN≈êRZ√âS ---
            // Itt ellen≈ërizz√ºk a headereket, k√∂zvetlen√ºl a fut√°s el≈ëtt.
            if (typeof(window.crossOriginIsolated) === 'undefined' || window.crossOriginIsolated === false) {
                logMessage("--- FAT√ÅLIS HEADER HIBA ---");
                logMessage("A 'window.crossOriginIsolated' = false.");
                logMessage("Ez azt jelenti, hogy a Render COOP/COEP headerek NINCSENEK √©rv√©nyben.");
                logMessage("A hiba oka: Makacs b√∂ng√©sz≈ë gyors√≠t√≥t√°r VAGY hib√°s Render be√°ll√≠t√°s.");
                logMessage("MEGOLD√ÅS: T√∂r√∂ld a b√∂ng√©sz≈ë cache-t, VAGY a Renderen 'Clear cache & deploy'.");
                throw new Error("Cross-origin isolation (COOP/COEP) HI√ÅNYZIK!");
            }
            logMessage("Header ellen≈ërz√©s (crossOriginIsolated) SIKERES ('true').");
            // --- ELLEN≈êRZ√âS V√âGE ---

            try {
                // Szekvenci√°lis (egym√°s ut√°ni) bet√∂lt√©s
                logMessage("1. l√©p√©s: F≈ë FFmpeg szkript bet√∂lt√©se...");
                await loadScript("./ffmpeg-dist/ffmpeg.min.js");
                
                logMessage("2. l√©p√©s: FFmpeg seg√©d-szkript (util) bet√∂lt√©se...");
                await loadScript("./ffmpeg-dist/ffmpeg-util.min.js");
                
                logMessage("Mindk√©t FFmpeg szkript sikeresen beh√≠vva (lok√°lisan).");
            } catch (error) {
                logMessage("FAT√ÅLIS HIBA a lok√°lis szkriptek beh√≠v√°sakor.");
                throw error;
            }
            
            await sleep(100); 
            
            if (!globalThis.FFmpeg || !globalThis.FFmpegUtil) {
                logMessage("FAT√ÅLIS HIBA: Az objektumok nem j√∂ttek l√©tre (ST).");
                logMessage("Ellen≈ërizd, hogy a 'setup_st.sh' szkript lefutott-e.");
                throw new Error("FFmpeg objektum nem tal√°lhat√≥ (id≈ëz√≠t√©si hiba).");
            }

            logMessage("FFmpeg objektumok sikeresen √©szlelve! Mag bet√∂lt√©se indul.");
            
            const { FFmpeg } = globalThis.FFmpeg; 
            ffmpeg = new FFmpeg();

            ffmpeg.on('log', ({ message }) => { /* Log sz≈±r√©s */ });
            ffmpeg.on('progress', ({ progress, time }) => {
                if (progress) {
                    updateStatus("Vide√≥/Hang feldolgoz√°s...", progress * 100);
                }
            });

            // EGY-SZ√ÅL√ö mag bet√∂lt√©se
            const baseURL = "./ffmpeg-dist";
            await ffmpeg.load({
                coreURL: `${baseURL}/ffmpeg-core.js`,
                wasmURL: `${baseURL}/ffmpeg-core.wasm`
            });
            
            logMessage("FFmpeg (ST) sikeresen bet√∂ltve (lok√°lisan).");
            return ffmpeg;
        }

        // --- √öJ AI Bet√∂lt≈ë ---
        async function loadAI() {
            if (pipeline) return pipeline; // Ha m√°r be van t√∂ltve
            
            logMessage("AI (Transformers.js) bet√∂lt√©se...");
            try {
                // Dinamikusan import√°ljuk az AI-t
                const transformers = await import("https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.1");
                pipeline = transformers.pipeline;
            } catch (e) {
                logMessage(`FAT√ÅLIS HIBA: Transformers.js import sikertelen: ${e.message}`);
                logMessage("Val√≥sz√≠n≈±leg az Ad-Blocker/Priv√°t DNS blokkolja a 'cdn.jsdelivr.net'-et.");
                throw e; // Dobjuk a hib√°t, hogy a f≈ë 'catch' elkapja
            }
            logMessage("AI (Transformers.js) sikeresen bet√∂ltve.");
            return pipeline;
        }

        // --- F≈ë Feldolgoz√≥ Funkci√≥ (V√ÅLTOZTATVA) ---
        processButton.addEventListener('click', async () => {
            inputFile = fileInput.files[0];
            if (!inputFile) { alert("K√©rlek, v√°lassz egy f√°jlt!"); return; }
            processButton.disabled = true;
            resultsContainer.style.display = 'none';
            logDiv.innerHTML = "";
            
            try {
                // --- 0. L√âP√âS: FFmpeg BET√ñLT√âSE (√©s Header-teszt) ---
                logMessage("0. l√©p√©s: FFmpeg bet√∂lt√©se (√©s Header ellen≈ërz√©s)...");
                const ffmpeg = await loadFFmpeg();
                const { fetchFile } = globalThis.FFmpegUtil;
                logMessage("FFmpeg bet√∂ltve.");
                
                // --- 1. L√âP√âS: AI BET√ñLT√âSE (most m√°r itt van) ---
                logMessage("1. l√©p√©s: AI Modellek bet√∂lt√©se...");
                const pipelineFunc = await loadAI(); // Ez a mi glob√°lis 'pipeline' v√°ltoz√≥nkat √°ll√≠tja be
                
                // Modellek let√∂lt√©se a CDN-r≈ël (ezt m√©g blokkolhatja az Ad-Blocker)
                const transcriber = await pipelineFunc('automatic-speech-recognition', 'Xenova/whisper-base', { progress_callback: progressCallback });
                const translator = await pipelineFunc('translation', 'Xenova/opus-mt-en-hu', { progress_callback: progressCallback });
                logMessage("AI Modellek bet√∂ltve.");
                
                // --- 2-5. L√âP√âS: V√ÅLTOZATLAN ---
                logMessage("2. l√©p√©s: Audio el≈ëfeldolgoz√°s FFmpeg-gel...");
                updateStatus("Hang kinyer√©se √©s √°talak√≠t√°sa...");
                await ffmpeg.writeFile('input_media', await fetchFile(inputFile));
                await ffmpeg.exec(['-i', 'input_media', '-vn', '-ac', '1', '-ar', '16000', '-f', 'f32le', 'audio.raw']);
                const audioData = await ffmpeg.readFile('audio.raw');
                const audioFloat32 = new Float32Array(audioData.buffer);
                logMessage("Audio el≈ëfeldolgoz√°s k√©sz.");
                
                logMessage("3. l√©p√©s: Besz√©dfelismer√©s ind√≠t√°sa...");
                updateStatus("Besz√©dfelismer√©s...", 0);
                const transcription = await transcriber(audioFloat32, {
                    chunk_length_s: 30, stride_length_s: 5, return_timestamps: 'chunks',
                    progress_callback: progressCallback
                });
                const detectedLang = transcription.lang;
                const chunks = transcription.chunks;
                logMessage(`ASR k√©sz. √âszlelt nyelv: ${detectedLang || 'ismeretlen'}.`);
                logMessage(`Felismerve ${chunks.length} sz√∂vegr√©szlet.`);
                
                logMessage("4. l√©p√©s: Logika √©s Ford√≠t√°s...");
                if (chunks.length === 0) {
                    logMessage("FIGYELEM: Nem tal√°lhat√≥ besz√©d a f√°jlban.");
                    updateStatus("Hiba: Nem tal√°lhat√≥ besz√©d.");
                    processButton.disabled = false; return;
                }
                if (detectedLang !== 'eng' && detectedLang !== 'en') {
                    logMessage(`HIBA: A √©szlelt nyelv '${detectedLang}', de ez a program csak angolr√≥l ('en') ford√≠t.`);
                    updateStatus("Hiba: A f√°jl nem angol.");
                    processButton.disabled = false; return;
                }
                logMessage("√âszlelt nyelv angol. Ford√≠t√°s magyarra folyamatban...");
                updateStatus("Ford√≠t√°s...");
                srtContent = "";
                for (let i = 0; i < chunks.length; i++) {
                    const chunk = chunks[i];
                    const startTime = formatTimestamp(chunk.timestamp[0]);
                    const endTime = formatTimestamp(chunk.timestamp[1]);
                    const englishText = chunk.text;
                    const translation = await translator(englishText);
                    const hungarianText = translation[0].translation_text;
                    srtContent += `${i + 1}\n${startTime} --> ${endTime}\n${hungarianText}\n\n`;
                    const percent = ((i + 1) / chunks.length) * 100;
                    updateStatus("Ford√≠t√°s...", percent);
                    if (i % 5 === 0) { logMessage(`Ford√≠tva ${i + 1}/${chunks.length}...`); }
                }
                logMessage("Ford√≠t√°s befejezve!");
                updateStatus("K√©sz!", 100);
                
                logMessage("5. l√©p√©s: Eredm√©nyek megjelen√≠t√©se.");
                resultsSrt.value = srtContent;
                resultsContainer.style.display = 'block';
                if (inputFile.type.startsWith('video/')) {
                    downloadVideoBtn.style.display = 'inline-block';
                } else {
                    downloadVideoBtn.style.display = 'none';
                }
            } catch (error) {
                logMessage(`FAT√ÅLIS HIBA: ${error.message}`);
                updateStatus(`Hiba: ${error.message}`);
                console.error(error);
                alert(`FAT√ÅLIS HIBA T√ñRT√âNT: ${error.message}`);
            } finally {
                processButton.disabled = false;
            }
        });

        // --- Let√∂lt√©si Funkci√≥k (V√ÅLTOZATLAN) ---
        downloadSrtBtn.addEventListener('click', () => {
            downloadBlob(new Blob([srtContent], { type: 'text/plain' }), 'felirat.srt');
        });
        downloadVideoBtn.addEventListener('click', async () => {
            // ... (A 'downloadVideoBtn' k√≥dja ugyanaz) ...
            downloadVideoBtn.disabled = true;
            updateStatus("Vide√≥ el≈ëk√©sz√≠t√©se...");
            try {
                const ffmpeg = await loadFFmpeg(); // √öjrah√≠vja, de az 'if (ffmpeg) return ffmpeg;' miatt gyors lesz
                const { fetchFile } = globalThis.FFmpegUtil;
                logMessage("F√°jlok √≠r√°sa az FFmpeg virtu√°lis mem√≥ri√°ba (Muxol√°s)...");
                await ffmpeg.writeFile('input.mp4', await fetchFile(inputFile));
                await ffmpeg.writeFile('subtitles.srt', srtContent);
                logMessage("Muxol√°s ind√≠t√°sa... (c copy - gyors)");
                updateStatus("Vide√≥ muxol√°sa...", 0);
                await ffmpeg.exec(['-i', 'input.mp4', '-i', 'subtitles.srt', '-c', 'copy', '-c:s', 'mov_text', '-map', '0', '-map', '1', '-metadata:s:s:0', 'language=hun', 'output.mp4']);
                logMessage("Muxol√°s k√©sz. F√°jl olvas√°sa...");
                const data = await ffmpeg.readFile('output.mp4');
                logMessage("Vide√≥ let√∂lt√©s√©nek ind√≠t√°sa...");
                downloadBlob(new Blob([data.buffer], { type: 'video/mp4' }), 'video_magyar_felirattal.mp4');
                updateStatus("Let√∂lt√©s k√©sz!");
            } catch (error) {
                logMessage(`HIBA a vide√≥ feldolgoz√°s√°n√°l: ${error.message}`);
                updateStatus(`Vide√≥ hiba: ${error.message}`);
            } finally {
                downloadVideoBtn.disabled = false;
            }
        });

        // --- Helper Funkci√≥k (V√ÅLTOZATLAN) ---
        function formatTimestamp(seconds) {
            const h = Math.floor(seconds / 3600); const m = Math.floor((seconds % 3600) / 60); const s = Math.floor(seconds % 60); const ms = Math.floor((seconds - Math.floor(seconds)) * 1000);
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(3, '0')}`;
        }
        function downloadBlob(blob, name) {
            const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = name; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        }
        
        logMessage("A v2.17-es (Szuper-Stabil) oldal k√©szen √°ll.");
        logMessage("K√©rlek, gy≈ëz≈ëdj meg r√≥la, hogy a 'setup_st.sh' szkript lefutott, √©s a 4 egy-sz√°l√∫ f√°jl van a rep√≥dban.");

    </script>
</body>
</html>
